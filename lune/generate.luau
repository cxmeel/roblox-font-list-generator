--!strict
local process = require("@lune/process")
local serde = require("@lune/serde")

local CloudFonts = require("./lib/CloudFonts")
local LocalFonts = require("./lib/LocalFonts")

local colors = require("./utils/colors")
local logger = require("./utils/logger")
local ufs = require("./utils/ufs")

local FILE_EXTENSION = "luau"
do
	local extPos = table.find(process.args, "--ext")

	if extPos then
		FILE_EXTENSION = process.args[extPos + 1]
	end
end

local localFonts = LocalFonts.fetchLocalFonts()
local cloudFonts = CloudFonts.fetchCloudFonts()

logger.debug("Found", colors.bold(#localFonts), "local fonts and", colors.bold(#cloudFonts), "cloud fonts")
print("Building font list from", colors.bold(#localFonts + #cloudFonts), "fonts")

local source = {
	[[--!strict
-- This file is automatically generated by Font List Generate
-- by @cxmeel (cxmeels). Do not edit this file manually.

export type IFont = {
    ContentUri: string,
    Name: string,
	SafeName: string,
    Aliases: { string },
    Weights: { Enum.FontWeight },
    Styles: { Enum.FontStyle },
}

local fonts: { IFont } = {
    -- Local fonts --]],
}

table.sort(localFonts, function(a, b)
	return a.Name < b.Name
end)

for _, font in localFonts do
	table.insert(source, `{font:ToString()},`)
end

table.insert(source, "-- Cloud fonts --")

table.sort(cloudFonts, function(a, b)
	return a.Name < b.Name
end)

for _, font in cloudFonts do
	table.insert(source, `{font:ToString()},`)
end

table.insert(
	source,
	[[}

return fonts
]]
)

print("Writing font list to", colors.blue(`build/FontList.{FILE_EXTENSION}`))
ufs.writeFile(`build/FontList.{FILE_EXTENSION}`, table.concat(source, "\n"))

logger.info("Formatting font list with stylua")
logger.debug("Config path:", colors.blue(".generated.stylua.toml"))
process.exec("stylua", { "build/", "--config-path", ".generated.stylua.toml" })

print("Writing JSON font list to", colors.blue("build/FontList.json"))

local jsonFontList = {}

for _, font in localFonts do
	table.insert(jsonFontList, font:ToDictionary())
end

for _, font in cloudFonts do
	table.insert(jsonFontList, font:ToDictionary())
end

ufs.writeFile("build/FontList.json", serde.encode("json", jsonFontList))

print(colors.green.bold.inverse(" SUCCESS "), "Font lists generated successfully! ðŸŽ‰")
